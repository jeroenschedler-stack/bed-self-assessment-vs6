<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BED HOSPITALITY 2.0 — Completed</title>
  <!-- Load jsPDF up front so it's ready at click time -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; background: #fafafa; color: #111; }
    header { padding: 18px 16px 6px; font-weight: 800; font-size: 22px; }
    .sub { padding: 0 16px 16px; color: #333; font-size: 16px; letter-spacing: .2px; }
    .page { padding: 16px; }
    .actions { display: flex; gap: 12px; justify-content: center; margin-top: 18px; }
    .sar-btn { font-size: 16px; border-radius: 10px; padding: 10px 18px; border: 1px solid #ccc; background: #fff; }
    /* BED blue PDF button */
    #finishPDF, #finishPDF.sar-btn, button#finishPDF.sar-btn {
      background-color: #1E90FF !important;
      border-color: #1E90FF !important;
      color: #ffffff !important;
    }
    /* Modal (24‑month style) */
    .modal-mask { position: fixed !important; inset: 0 !important; background: rgba(0,0,0,0.45) !important; z-index: 99998 !important; display:none; }
    .modal.modal-24m {
      position: fixed !important; left: 50% !important; top: 30% !important; transform: translateX(-50%) !important;
      background: #FFFFFF !important; border-radius: 14px !important; box-shadow: 0 12px 30px rgba(0,0,0,0.25) !important;
      width: min(520px, 92vw) !important; padding: 18px 20px !important; z-index: 99999 !important; display:none;
    }
    .modal-24m .modal-title { margin: 0 0 6px 0; font-size: 18px; font-weight: 700; }
    .modal-24m .modal-body { font-size: 14px; color: #333; }
    .modal-24m .modal-footer { text-align: right; margin-top: 12px; }
    .modal-24m .modal-primary { background: #1E90FF; border-color: #1E90FF; color: #fff; border-radius: 10px; padding: 8px 14px; }
    .modal-24m .modal-primary:active { opacity: .9; }
  </style>
</head>
<body>
  <header>BED HOSPITALITY 2.0</header>
  <div class="sub">SELF‑ ASSESSMENT COMPLETED</div>

  <div class="page">
    <div class="actions">
      <button class="sar-btn" id="goBack" onclick="history.back()">Back</button>
      <button class="sar-btn" id="finishPDF">PDF</button>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="pdfDoneMask" class="modal-mask"></div>
  <div id="pdfDoneModal" class="modal modal-24m" role="dialog" aria-modal="true" aria-labelledby="pdfDoneTitle">
    <div class="modal-header">
      <h3 id="pdfDoneTitle" class="modal-title">Done! Your test results are ready.</h3>
    </div>
    <div class="modal-body">
      <p>Test results downloaded.</p>
    </div>
    <div class="modal-footer">
      <button id="pdfDoneOK" class="btn btn-primary modal-primary" type="button">OK</button>
    </div>
  </div>

  <!-- Embedded questions (replace with your real list if needed) -->
  <script id="embeddedQuestions" type="application/json">[]</script>

  <script>
    // Modal helpers
    function openPdfDone(){
      try{
        const m = document.getElementById('pdfDoneModal');
        const k = document.getElementById('pdfDoneMask');
        if (k) k.style.display = 'block';
        if (m) {
          m.style.display = 'block';
          const ok = document.getElementById('pdfDoneOK');
          if (ok) ok.onclick = closePdfDone;
        }
      }catch(e){}
    }
    function closePdfDone(){
      const m = document.getElementById('pdfDoneModal');
      const k = document.getElementById('pdfDoneMask');
      if (k) k.style.display = 'none';
      if (m) m.style.display = 'none';
    }

    // Suppress legacy "PDF download failed" alert if some old path still calls it
    (function(){
      try {
        const _oldAlert = window.alert;
        window.alert = function(msg){
          try { if (typeof msg === 'string' && msg.toLowerCase().includes('pdf download failed')) return; } catch(_){}
          return _oldAlert.apply(window, arguments);
        };
      } catch(_) {}
    })();

    // PDF generation – synchronous click → save
    (function(){
      function getJsPDF(){
        try { return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; } catch(_) { return null; }
      }
      function getQuestionsSync(){
        try {
          if (window.sarState && Array.isArray(window.sarState.questions) && window.sarState.questions.length) {
            return window.sarState.questions;
          }
          const node = document.getElementById('embeddedQuestions');
          if (node && node.textContent) {
            const arr = JSON.parse(node.textContent);
            if (Array.isArray(arr)) {
              window.sarState = window.sarState || {};
              window.sarState.questions = arr;
              return arr;
            }
          }
        } catch(_){}
        return [];
      }
      function getStateSync(){
        const S = (window.sarState = window.sarState || {});
        if (!S.answers || Object.keys(S.answers).length === 0) {
          try {
            document.querySelectorAll('.q-item input[type="radio"]:checked').forEach(inp => {
              const wrap = inp.closest('.q-item'); if (!wrap) return;
              const qid = wrap.getAttribute('data-qid'); const v = parseInt(inp.value, 10);
              if (!S.answers) S.answers = {};
              if (qid && v>=1 && v<=5) S.answers[qid] = v;
            });
          } catch(_){}
          if (!S.answers || Object.keys(S.answers).length === 0) {
            try {
              const saved = localStorage.getItem('sarState');
              if (saved) {
                const tmp = JSON.parse(saved);
                if (tmp && tmp.answers) S.answers = tmp.answers;
                if (tmp && tmp.user && !S.user) S.user = tmp.user;
                if (tmp && tmp.peer && !S.peer) S.peer = tmp.peer;
              }
            } catch(_){}
          }
        }
        S.user = S.user || { nickname: '', email: '', hotel: '' };
        S.peer = S.peer || { name: '', email: '', hotel: '' };
        return S;
      }

      function savePdfNow(){
        if (window.__pdfSaving) return false;
        window.__pdfSaving = true; setTimeout(function(){ window.__pdfSaving = false; }, 800);

        var JS = getJsPDF();
        if (!JS) { try { alert('PDF library is not loaded.'); } catch(_){ } return false; }

        var S  = getStateSync();
        var qs = getQuestionsSync();
        var A  = S.answers || {};

        var totalW = 0, earned = 0;
        for (var i=0;i<qs.length;i++){
          var w = typeof qs[i].weight === 'number' && isFinite(qs[i].weight) ? qs[i].weight : 1;
          var v = parseInt(A[qs[i].id],10);
          totalW += w;
          if (v>=1 && v<=5) earned += v*w;
        }
        var pct = totalW>0 ? Math.round((earned/(totalW*5))*100) : 0;

        var doc = new JS({unit:'pt', format:'a4'});
        var x = 42, y = 56, line = 16;
        function add(txt, bold){ doc.setFont('helvetica', bold?'bold':'normal'); doc.setFontSize(11); doc.text(String(txt), x, y); y += line; }
        function gap(px){ y += (px||8); }

        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('BED SELF-ASSESSMENT RESULT', x, y); y += 24;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text('Generated: ' + new Date().toLocaleString(), x, y); y += 18;

        add('TEAM MEMBER', true);
        add('Name: ' + (S.user.nickname || '-'));
        add('BED Hotel: ' + (S.user.hotel || '-'));
        add('Email address: ' + (S.user.email || '-'));
        gap(8);

        add('PEER REVIEWER', true);
        add('Name: ' + (S.peer.name || '-'));
        add('BED Hotel: ' + (S.peer.hotel || '-'));
        add('Email address: ' + (S.peer.email || '-'));
        gap(10);

        add('ASSESSMENT SCORE', true);
        add('YOUR SCORE IS ' + pct + '%', true);
        add(earned.toFixed(1) + ' / ' + (totalW*5).toFixed(1));
        gap(10);

        add('Statement    Answer  Weight', true);
        for (var j=0;j<qs.length;j++){
          var st = (qs[j].statement || ('Statement ' + (j+1)));
          var sub = qs[j].subtext ? (' — ' + qs[j].subtext) : '';
          var v = (A[qs[j].id] != null ? String(A[qs[j].id]) : '-');
          var w = (typeof qs[j].weight === 'number' && isFinite(qs[j].weight)) ? qs[j].weight : 1;
          var text = (j+1) + ') ' + st + sub;
          doc.setFont('helvetica','normal'); doc.setFontSize(11);
          var maxWidth = 370;
          var lines = doc.splitTextToSize(text, maxWidth);
          for (var k=0;k<lines.length;k++){
            doc.text(lines[k], x, y);
            if (k===0){ doc.text(String(v).padStart(2,' '), x+maxWidth+14, y); doc.text(String(w), x+maxWidth+70, y); }
            y += line;
            if (y > 780){ doc.addPage(); y = 56; }
          }
        }

        function fmtStamp(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}-${p(d.getSeconds())}`; }
        var namePart = String(S.user && S.user.nickname || 'User').replace(/\s+/g,'_');
        var fname = `BED_Assessment_${namePart}_` + fmtStamp(new Date()) + '.pdf';

        try { doc.save(fname); } catch(e){ try { alert('PDF save failed: '+e); } catch(_){} return false; }
        try { setTimeout(function(){ if (typeof openPdfDone==='function') openPdfDone(); }, 140); } catch(_){}
        return true;
      }

      function wire(){
        var btn = document.getElementById('finishPDF');
        if (btn && !btn.__wired) { btn.__wired = true; btn.onclick = function(){ return savePdfNow(); }; }
      }
      document.addEventListener('DOMContentLoaded', wire);
      document.addEventListener('readystatechange', wire);
      new MutationObserver(wire).observe(document.documentElement, {subtree:true, childList:true});

      // Expose for manual call if needed
      window.savePdfNow = savePdfNow;
    })();
  </script>
</body>
</html>
