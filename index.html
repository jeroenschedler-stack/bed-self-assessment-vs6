<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BED – Completion</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111;line-height:1.4}
    .wrap{max-width:820px;margin:0 auto;padding:20px}
    h1{font-size:28px;margin:16px 0 4px}
    .subtitle{color:#666;margin:0 0 20px}
    .btns{display:flex;gap:12px}
    button{padding:12px 18px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:700}
    #finishPDF{background:#2563eb;color:#fff;border-color:#2563eb}
    /* Modal CSS */
    .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;display:none}
    .modal{position:fixed;left:50%;top:30%;transform:translateX(-50%);background:#fff;z-index:9999;
            max-width:520px;width:88%;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px 18px;display:none}
    .modal-footer{text-align:right}
    .btn-primary{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 12px}
  </style>
  <!-- jsPDF loaded at page load (not on click) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>BED HOSPITALITY 2.0</h1>
    <p class="subtitle">SELF‑ ASSESSMENT COMPLETED</p>
    <div class="btns">
      <button onclick="history.back()">Back</button>
      <button id="finishPDF">PDF</button>
    </div>
  </div>

  <!-- Success Modal shown AFTER download trigger -->
  <div id="pdfDoneMask" class="modal-mask"></div>
  <div id="pdfDoneModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pdfDoneTitle">
    <div class="modal-header">
      <h3 id="pdfDoneTitle">Done!</h3>
    </div>
    <div class="modal-body">
      <p>Your assessment report with recommendations is downloaded.</p>
    </div>
    <div class="modal-footer">
      <button id="pdfDoneOK" class="btn-primary" type="button">OK</button>
    </div>
  </div>

  <!-- Embedded questions for synchronous access -->
  <script id="embeddedQuestions" type="application/json">[{"id": "q1", "statement": "1. I reply to guests very quickly", "subtext": "I often check for messages and answer right away"}, {"id": "q2", "statement": "2. I make my replies warm and personal", "subtext": "I use their name and add helpful information"}, {"id": "q3", "statement": "3. I make a great first impression", "subtext": "I know that starts from the very first message"}, {"id": "q4", "statement": "4. I can see if a guest is stressed or relaxed", "subtext": "I adjust the way I check-in to the mood"}, {"id": "q5", "statement": "5. I ask questions before I ask passports", "subtext": "I welcome guests like friends"}, {"id": "q6", "statement": "6. I can check-in a guest in 60 seconds", "subtext": "I timed this three times with standard check-ins"}, {"id": "q7", "statement": "7. I check in groups differently than FIT", "subtext": "I usually check-in groups with the leader"}, {"id": "q8", "statement": "8. I don't tell guests that check-in time is 14:00", "subtext": "They can check-in as soon as the room is ready"}, {"id": "q9", "statement": "9. I don't show stress when there is a problem", "subtext": "I know that makes guests really worry"}, {"id": "q10", "statement": "10. I show genuine interest during check-out", "subtext": "I ask about their stay or next destination"}, {"id": "q11", "statement": "11. I make great last impressions", "subtext": "I walk them out and wait until their car has left"}, {"id": "q12", "statement": "12. I use names to connect with guests", "subtext": "When it feels right I tell my name and use theirs"}, {"id": "q13", "statement": "13. I scan every guest every time", "subtext": "I don't look at a group but at each individual"}, {"id": "q14", "statement": "14. I am good at scanning", "subtext": "I see what people need before they ask"}, {"id": "q15", "statement": "15. I create unique surprises for guests", "subtext": "I do more than offering free things"}, {"id": "q16", "statement": "16. Music is an essential part of the vibe", "subtext": "I listen to make sure we play the right music"}, {"id": "q17", "statement": "17. I invite guests to share other BED facilities", "subtext": "I offer downtown coffee, bigger pool or breakfast"}, {"id": "q18", "statement": "18. its annoying when a room key doesn't work", "subtext": "I go up to make sure the new key works"}, {"id": "q19", "statement": "19. I talk with guests because I am interested", "subtext": "When I force myself it will not be real"}, {"id": "q20", "statement": "20. I often give my friends honest feedback", "subtext": "I’m happy to help them to grow"}, {"id": "q21", "statement": "21. My friends often give me honest feedback", "subtext": "I’m happy they help me to grow"}, {"id": "q22", "statement": "22. I can answer most questions about BED", "subtext": "I have visited the rooms in all our hotels"}, {"id": "q23", "statement": "23. I understand the meaning of \"showtime\"", "subtext": "The magic happens from 07:00-10:00"}, {"id": "q24", "statement": "24. I know the story of \"peeling the onion\"", "subtext": "I don't act. Usually I show my true self"}, {"id": "q25", "statement": "25. I never gossip. I signed “I Promise”", "subtext": "I don't talk bad when someone's not here"}, {"id": "q26", "statement": "26. I really understand that rules can be flexible", "subtext": "Without reasons many rules just disappear"}, {"id": "q27", "statement": "27. I am confident about my own judgment", "subtext": "I make decisions without asking permission"}, {"id": "q28", "statement": "28. I look after the rooms and public areas", "subtext": "I share responsibility for the whole hotel"}, {"id": "q29", "statement": "29. I look around when I arrive at the hotel", "subtext": "I share responsibility for the whole hotel"}, {"id": "q30", "statement": "30. I don't pass problems to others but act myself", "subtext": "I follow up later to make sure it's fixed"}, {"id": "q31", "statement": "31. I am not afraid of the CEO or my coach", "subtext": "I know I am allowed to make mistakes"}, {"id": "q32", "statement": "32. I have no manuals that show me what to do", "subtext": "That means I cannot do anything wrong"}]</script>

  <script>
    // Modal helpers
    function openPdfDone(){ try{ 
      var m=document.getElementById('pdfDoneModal'); var k=document.getElementById('pdfDoneMask');
      if(k) k.style.display='block'; if(m){ m.style.display='block'; var ok=document.getElementById('pdfDoneOK'); if(ok) ok.onclick=closePdfDone; }
    }catch(_){} }
    function closePdfDone(){ var m=document.getElementById('pdfDoneModal'); var k=document.getElementById('pdfDoneMask'); if(k) k.style.display='none'; if(m) m.style.display='none'; }

    // Minimal state placeholder (real app may overwrite this before clicking PDF)
    window.sarState = window.sarState || {
      user: { nickname: 'Jeroen', email: 'jeroen.schedler@gmail.com', hotel: 'BPS' },
      peer: { name: '', email: '', hotel: '' },
      answers: {}
    };

    // Synchronous PDF save (Batch A wording and layout)
    function savePdfNow(){
      var JS = (function(){ try{ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }catch(_){ return null; } })();
      if(!JS){ alert('PDF library is not loaded.'); return false; }

      var S = (window.sarState = window.sarState || {});
      // collect answers from DOM if present
      if(!S.answers || Object.keys(S.answers).length===0){ try{ 
        document.querySelectorAll('.q-item input[type="radio"]:checked').forEach(function(inp){ 
          var wrap=inp.closest('.q-item'); if(!wrap) return; var qid=wrap.getAttribute('data-qid'); var v=parseInt(inp.value,10);
          if(!S.answers) S.answers={}; if(qid && v>=1 && v<=5) S.answers[qid]=v;
        });
      }catch(_){}}
      // localStorage fallback
      if(!S.answers || Object.keys(S.answers).length===0){ try{ var saved=localStorage.getItem('sarState'); if(saved){ var t=JSON.parse(saved); if(t && t.answers) S.answers=t.answers; if(t && t.user && !S.user) S.user=t.user; if(t && t.peer && !S.peer) S.peer=t.peer; } }catch(_){} }

      S.user = S.user || { nickname:'', email:'', hotel:'' };
      S.peer = S.peer || { name:'', email:'', hotel:'' };

      function getQuestionsSync(){ try{ var n=document.getElementById('embeddedQuestions'); if(n && n.textContent){ var arr=JSON.parse(n.textContent); if(Array.isArray(arr)) return arr; } }catch(_){ } return []; }
      var qs = getQuestionsSync(); var A = S.answers || {};

      // compute weighted score
      var totalW=0, earned=0;
      for(var i=0;i<qs.length;i++){ var w=(typeof qs[i].weight==='number' && isFinite(qs[i].weight))?qs[i].weight:1; var v=parseInt(A[qs[i].id],10); totalW+=w; if(v>=1 && v<=5) earned += v*w; }
      var pct = totalW>0 ? Math.round((earned/(totalW*5))*100) : 0;

      function fmtDateFancy(d){ try{ var days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; var months=['January','February','March','April','May','June','July','August','September','October','November','December']; return days[d.getDay()]+', '+String(d.getDate()).padStart(2,'0')+' '+months[d.getMonth()]+' '+d.getFullYear(); }catch(_){ return d.toLocaleDateString(); } }
      var today = new Date();

      var doc = new JS({unit:'pt', format:'a4'});
      var x=42,y=56,line=16;

      // Header
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('BED Self-Assessment Report — '+pct+'%', x, y); y+=28;

      // Information Team Member
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('INFORMATION TEAM MEMBER', x, y); y+=line;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text('Assessment Date: '+fmtDateFancy(today), x, y); y+=line;

      doc.text('Name employee: '+(S.user.nickname||'-'), x, y); y+=line;
      doc.text('Location: '+(S.user.hotel||'-'), x, y); y+=line;
      doc.text('Email: '+(S.user.email||'-'), x, y); y+=line+4;

      // Information Peer Reviewer
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('INFORMATION PEER REVIEWER', x, y); y+=line;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text('Name employee: '+(S.peer.name||'-'), x, y); y+=line;
      doc.text('Location: '+(S.peer.hotel||'-'), x, y); y+=line;
      doc.text('Email: '+(S.peer.email||'-'), x, y); y+=line+8;

      // Assessment score (no blank line)
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('ASSESSMENT SCORE', x, y); y+=line;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text('Your assessment percentage is '+pct+'%', x, y); y+=line;
      var maxPoints=(totalW*5).toFixed(0), earnedStr=(earned.toFixed(0));
      doc.text('Your assessment score is '+earnedStr+' out of '+maxPoints, x, y); y+=line+6;

      // Table header
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      var colX={ stmt:x, score:x+410, weight:x+470 };
      doc.text('Statement', colX.stmt, y);
      doc.text('Score', colX.score, y);
      doc.text('Weight', colX.weight, y);
      y+=10; doc.setLineWidth(0.5); doc.line(x, y, x+520, y); y+=12;

      // Rows
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      for(var j=0;j<qs.length;j++){ 
        var st=(qs[j].statement||('Statement '+(j+1)));
        var sub=qs[j].subtext?(' — '+qs[j].subtext):'';
        var v=(A[qs[j].id]!=null? String(A[qs[j].id]) : '-');
        var w=(typeof qs[j].weight==='number' && isFinite(qs[j].weight))?qs[j].weight:1;
        var text=(j+1)+'. '+st+sub;
        var lines=doc.splitTextToSize(text, 400);
        for(var k=0;k<lines.length;k++){ 
          doc.text(lines[k], colX.stmt, y);
          if(k===0){ doc.text(String(v), colX.score, y); doc.text(String(w), colX.weight, y); }
          y+=line; if(y>780){ doc.addPage(); y=56; }
        }
      }

      function fmtStamp(d){ function p(n){return String(n).padStart(2,'0')}; return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+'_'+p(d.getHours())+'-'+p(d.getMinutes())+'-'+p(d.getSeconds()); }
      var fname='BED_Assessment_'+(S.user.nickname?S.user.nickname.replace(/\s+/g,'_'):'User')+'_'+fmtStamp(today)+'.pdf';
      try{ doc.save(fname); }catch(e){ alert('PDF save failed: '+e); return false; }
      setTimeout(openPdfDone, 120);
      return true;
    }

    // Wire the PDF button with a simple single-download guard
    (function(){
      var btn=document.getElementById('finishPDF'); var lock=false;
      if(btn) btn.addEventListener('click', function(){ if(lock) return; lock=true; try{ savePdfNow(); }finally{ setTimeout(function(){ lock=false; }, 600); } });
    })();
  </script>
</body>
</html>
